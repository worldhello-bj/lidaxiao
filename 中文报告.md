# 李大霄指数计算程序实现报告

## 项目概述

本项目成功实现了基于B站视频数据的李大霄指数计算程序，完全按照README.md中的规格要求开发。程序能够自动爬取指定UP主（UID: 2137589551）最近7天的视频数据，计算李大霄指数，并生成详细的数据可视化图表。

## 核心功能实现

### 1. 视频数据爬取模块

**实现特点：**
- 使用 `bilibili-api-python` 库异步调用B站官方API
- 按照发布时间顺序获取视频数据（`user.VideoOrder.PUBDATE`）
- 精确过滤[start_date, end_date]日期范围内的视频
- 完整处理分页逻辑，确保获取所有符合条件的视频
- 提取关键字段：视频ID、播放量、评论数、发布日期、标题、时间戳

**技术实现：**
```python
async def fetch_videos(uid, start_date, end_date):
    """获取指定日期范围内的视频数据"""
    u = user.User(uid)
    all_videos = []
    pn = 1
    
    while True:
        res = await u.get_videos(pn=pn, order=user.VideoOrder.PUBDATE)
        if not res["list"]["vlist"]:
            break
        # 日期过滤和数据提取逻辑
        pn += 1
```

### 2. 李大霄指数计算算法

**计算公式严格执行规范要求：**
- 单视频指数 = （播放量 ÷ 10000）+（评论数 ÷ 100）
- 总指数 = 所有符合条件视频的单视频指数之和
- 无视频时自动返回0.0

**实现代码：**
```python
def calculate_index(videos):
    """计算李大霄指数"""
    total = 0.0
    for v in videos:
        video_index = (v["view"] / 10000) + (v["comment"] / 100)
        total += video_index
    return total
```

### 3. 数据存储系统

**存储格式：**
- **单日数据文件**：`YYYY-MM-DD.json`
  - 格式：`{"date": "2025-01-15", "index": 268.58}`
- **历史累积数据**：`history.json`
  - 采用追加模式，包含所有历史记录
  - 格式：`[{"date": "2025-01-14", "index": 245.32}, ...]`

### 4. 数据可视化系统

程序自动生成两种专业级数据可视化图表：

#### 4.1 历史趋势折线图
- **文件名**：`index_history_YYYYMMDD.png`
- **功能**：展示李大霄指数的历史变化趋势
- **特点**：
  - X轴：日期序列，自动旋转45度避免重叠
  - Y轴：指数数值
  - 包含网格线提升可读性
  - 使用圆点标记每日数据点

#### 4.2 单日贡献堆叠图
- **文件名**：`index_stack_YYYYMMDD.png`
- **功能**：详细展示当日各视频对总指数的贡献
- **特点**：
  - 采用堆叠柱状图设计
  - 视频按发布时间倒序排列（最新视频在顶部）
  - 右侧图例显示各视频标题（超长标题自动截断）
  - 无视频时显示特殊提示图表

### 5. 中文字体支持

程序完善处理了中文显示问题：
```python
plt.rcParams['font.sans-serif'] = ['DejaVu Sans', 'Arial Unicode MS', 'SimHei', 'Microsoft YaHei']
plt.rcParams['axes.unicode_minus'] = False
```

## 项目文件结构

```
lidaxiao/
├── lidaxiao.py          # 主程序（生产版本）
├── demo.py             # 演示程序（模拟数据版本）
├── requirements.txt    # 依赖库清单
├── USAGE.md           # 英文使用说明
├── 中文报告.md         # 中文实现报告（本文件）
├── README.md          # 项目规格说明
└── .gitignore         # Git忽略文件配置
```

## 使用方法

### 生产环境运行
```bash
# 安装依赖
pip install -r requirements.txt

# 运行主程序
python3 lidaxiao.py
```

### 演示模式运行
```bash
# 使用模拟数据演示功能
python3 demo.py
```

## 依赖库说明

| 库名 | 版本要求 | 用途说明 |
|------|----------|----------|
| bilibili-api-python | >=16.0.0 | B站API接口调用 |
| matplotlib | >=3.5.0 | 数据可视化图表生成 |
| httpx | >=0.27.0 | HTTP客户端支持 |

## 输出文件说明

### JSON数据文件
- **单日数据**：记录每日计算的指数值和日期
- **历史数据**：累积存储所有历史记录，支持趋势分析

### 可视化图表
- **历史趋势图**：直观展示指数随时间变化的趋势
- **贡献分解图**：详细分析当日各视频的指数贡献度

## 技术特色

### 1. 异步编程优化
- 使用Python异步编程提升API调用效率
- 非阻塞式数据获取，提高程序响应速度

### 2. 错误处理机制
- 完善的API调用错误处理
- 网络异常自动重试机制
- 数据解析容错处理

### 3. 跨平台兼容性
- 使用非交互式matplotlib后端，支持无头环境
- 自动字体回退机制，确保中文正常显示
- 兼容Linux、Windows、macOS系统

### 4. 模块化设计
- 功能模块清晰分离
- 代码结构易于维护和扩展
- 支持单元测试

## 演示程序特色

为了便于测试和演示，特别开发了`demo.py`演示版本：

### 模拟数据生成
- 智能生成符合真实场景的模拟视频数据
- 播放量范围：1万-50万，符合实际分布
- 评论数范围：50-2000，保持合理比例
- 自动生成中文视频标题

### 完整功能演示
- 展示完整的指数计算过程
- 生成与生产版本相同格式的输出文件
- 详细输出每个视频的指数贡献

## 执行流程图

```
开始
  ↓
确定日期范围（当前日期往前推7天）
  ↓
调用B站API获取视频数据
  ↓
筛选日期范围内的视频
  ↓
计算李大霄指数
  ↓
保存JSON数据文件
  ↓
生成历史趋势图
  ↓
生成单日贡献图
  ↓
结束
```

## 计算示例

**假设某日获取到3个视频：**
- 视频A：播放量100000，评论数500
  - 单视频指数 = 100000÷10000 + 500÷100 = 10 + 5 = 15
- 视频B：播放量50000，评论数200  
  - 单视频指数 = 50000÷10000 + 200÷100 = 5 + 2 = 7
- 视频C：播放量20000，评论数100
  - 单视频指数 = 20000÷10000 + 100÷100 = 2 + 1 = 3

**当日李大霄指数 = 15 + 7 + 3 = 25.0**

## 注意事项

### 网络环境要求
- 生产版本需要访问`space.bilibili.com`域名
- 如遇网络限制，建议使用演示版本测试功能

### 字体显示
- 程序已配置多种中文字体回退方案
- 如出现字体警告，不影响核心功能运行

### 数据更新频率
- 建议每日运行一次，获取最新7天数据
- 支持多次运行，历史数据自动累积

## 项目总结

本项目完全按照README.md规格要求实现，具备以下优势：

1. **功能完整性**：涵盖数据爬取、指数计算、存储、可视化全流程
2. **技术先进性**：采用异步编程、模块化设计等现代编程实践
3. **用户友好性**：提供演示版本、详细文档、中文支持
4. **扩展性强**：代码结构清晰，易于后续功能扩展
5. **跨平台性**：支持多种操作系统和运行环境

项目成功实现了李大霄指数的自动化计算与可视化分析，为相关数据分析工作提供了可靠的技术支持。